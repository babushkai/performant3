name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check version bump
        id: bump
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Determine bump type from PR title
          if [[ "$TITLE" =~ ^feat ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif [[ "$TITLE" =~ ^fix ]]; then
            echo "type=patch" >> $GITHUB_OUTPUT
          elif [[ "$TITLE" =~ ^(docs|chore|style|refactor|test|ci) ]]; then
            echo "type=skip" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Calculate version
        if: steps.bump.outputs.type != 'skip'
        id: version
        run: |
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CURRENT=${CURRENT#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ steps.bump.outputs.type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          echo "version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

      - name: Update version
        if: steps.bump.outputs.type != 'skip'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" Info.plist

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Info.plist
          git commit -m "chore: bump version to $VERSION [skip ci]"
          git push

      - uses: maxim-lobanov/setup-xcode@v1
        if: steps.bump.outputs.type != 'skip'
        with:
          xcode-version: latest-stable

      - name: Build
        if: steps.bump.outputs.type != 'skip'
        run: |
          xcodebuild -scheme MacML -destination 'platform=macOS' -configuration Release \
            -derivedDataPath DerivedData CODE_SIGNING_ALLOWED=NO -quiet build

      - name: Package
        if: steps.bump.outputs.type != 'skip'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          mkdir -p MacML.app/Contents/{MacOS,Resources}
          cp DerivedData/Build/Products/Release/MacML MacML.app/Contents/MacOS/
          cp Info.plist MacML.app/Contents/
          for b in DerivedData/Build/Products/Release/*.bundle; do [ -d "$b" ] && cp -R "$b" MacML.app/Contents/Resources/; done
          echo -n "APPL????" > MacML.app/Contents/PkgInfo
          codesign --force --deep --sign - MacML.app

          # Create DMG
          mkdir dmg && cp -R MacML.app dmg/ && ln -s /Applications dmg/
          hdiutil create -volname MacML -srcfolder dmg -ov -format UDZO MacML-${VERSION}.dmg

          # Create ZIP
          ditto -c -k --keepParent MacML.app MacML-${VERSION}.zip

      - name: Release
        if: steps.bump.outputs.type != 'skip'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag -a "v$VERSION" -m "v$VERSION"
          git push origin "v$VERSION"

          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --generate-notes \
            MacML-${VERSION}.dmg \
            MacML-${VERSION}.zip
