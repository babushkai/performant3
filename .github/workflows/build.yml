name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v6

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ hashFiles('Package.resolved') }}

      - name: Build & Test
        run: swift test -c release --parallel

      - name: Package
        if: github.event_name == 'pull_request'
        run: |
          xcodebuild -scheme MacML -destination 'platform=macOS' -configuration Release \
            -derivedDataPath DerivedData CODE_SIGNING_ALLOWED=NO -quiet build

          mkdir -p MacML.app/Contents/{MacOS,Resources}
          cp DerivedData/Build/Products/Release/MacML MacML.app/Contents/MacOS/
          cp Info.plist MacML.app/Contents/
          for b in DerivedData/Build/Products/Release/*.bundle; do [ -d "$b" ] && cp -R "$b" MacML.app/Contents/Resources/; done
          echo -n "APPL????" > MacML.app/Contents/PkgInfo
          codesign --force --deep --sign - MacML.app
          ditto -c -k --keepParent MacML.app MacML-pr${{ github.event.pull_request.number }}.zip

      - uses: actions/upload-artifact@v6
        if: github.event_name == 'pull_request'
        with:
          name: MacML-pr${{ github.event.pull_request.number }}
          path: MacML-pr${{ github.event.pull_request.number }}.zip
          retention-days: 7
