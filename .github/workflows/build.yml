name: Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build and Test
    runs-on: macos-14  # Apple Silicon runner (required for MLX)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build application
        run: |
          xcodebuild -scheme Performant3 \
            -destination 'platform=macOS' \
            -configuration Release \
            build

      - name: Verify build artifacts
        run: |
          DERIVED_DATA=$(xcodebuild -scheme Performant3 -showBuildSettings 2>/dev/null | grep -m 1 'BUILT_PRODUCTS_DIR' | awk '{print $3}')

          if [ -z "$DERIVED_DATA" ]; then
            DERIVED_DATA=$(find ~/Library/Developer/Xcode/DerivedData -name "peformant3-*" -type d 2>/dev/null | head -1)/Build/Products/Release
          fi

          echo "Checking build artifacts in: $DERIVED_DATA"

          # Verify executable exists
          if [ ! -f "$DERIVED_DATA/Performant3" ]; then
            echo "ERROR: Executable not found!"
            exit 1
          fi

          # Verify Metal bundle exists (critical for MLX)
          if [ ! -d "$DERIVED_DATA/mlx-swift_Cmlx.bundle" ]; then
            echo "WARNING: MLX Metal bundle not found - Metal operations may fail"
          fi

          echo "Build artifacts verified successfully"
          ls -la "$DERIVED_DATA"
