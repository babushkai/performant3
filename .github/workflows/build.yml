name: CI

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
      - 'LICENSE'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  APP_NAME: MacML
  XCODE_VERSION: '16.2'

jobs:
  # Fast: ~15s
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --reporter github-actions-logging
        continue-on-error: true

  # Fast: ~5s  
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Secrets scan
        run: |
          ! grep -rE "(password|secret|api[_-]?key|token)\s*[:=]\s*['\"][^'\"]+['\"]" \
            --include="*.swift" Sources/ 2>/dev/null

  # Slow: ~3-5 min (SPM deps)
  test:
    name: Test
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-

      - name: Test
        run: swift test -c release --parallel

  # Slow: ~2-3 min (reuses cache)
  build:
    name: Build
    runs-on: macos-14
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-

      - name: Build
        run: |
          xcodebuild -scheme MacML \
            -destination 'platform=macOS' \
            -configuration Release \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            -quiet \
            build

      - name: Package
        id: pkg
        run: |
          V="${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'dev' }}-${GITHUB_SHA::7}"
          echo "version=$V" >> $GITHUB_OUTPUT
          
          P="DerivedData/Build/Products/Release"
          A="${APP_NAME}.app"
          
          mkdir -p "$A/Contents/"{MacOS,Resources,Frameworks}
          cp "$P/MacML" "$A/Contents/MacOS/"
          cp Info.plist "$A/Contents/"
          for b in "$P"/*.bundle; do [ -d "$b" ] && cp -R "$b" "$A/Contents/Resources/"; done
          [ -d "Resources/Scripts" ] && cp -R Resources/Scripts "$A/Contents/Resources/"
          echo -n "APPL????" > "$A/Contents/PkgInfo"
          codesign --force --deep --sign - "$A"
          ditto -c -k --keepParent "$A" "${APP_NAME}-${V}.zip"
          echo "zip=${APP_NAME}-${V}.zip" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ steps.pkg.outputs.version }}
          path: ${{ steps.pkg.outputs.zip }}
          retention-days: 7

      - name: Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### âœ… Build \`${{ steps.pkg.outputs.version }}\`\n[Download](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            const {data:comments} = await github.rest.issues.listComments({owner:context.repo.owner,repo:context.repo.repo,issue_number:context.issue.number});
            const c = comments.find(x=>x.user.type==='Bot'&&x.body.includes('Build'));
            if(c) await github.rest.issues.updateComment({owner:context.repo.owner,repo:context.repo.repo,comment_id:c.id,body});
            else await github.rest.issues.createComment({owner:context.repo.owner,repo:context.repo.repo,issue_number:context.issue.number,body});
