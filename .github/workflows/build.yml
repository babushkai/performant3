name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  APP_NAME: MacML
  XCODE_VERSION: '16.2'

jobs:
  # ============================================
  # Fast checks (no dependencies needed)
  # ============================================
  lint:
    name: Lint
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Run SwiftLint
        run: |
          brew install swiftlint
          swiftlint lint --reporter github-actions-logging || true

  security:
    name: Security
    runs-on: ubuntu-latest  # Cheaper runner - just needs grep
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for secrets
        run: |
          if grep -rE "(password|secret|api[_-]?key|token)\s*[:=]\s*['\"][^'\"]+['\"]" \
            --include="*.swift" Sources/ 2>/dev/null; then
            echo "::warning::Potential hardcoded secrets found"
          fi

  # ============================================
  # Tests (needs SPM dependencies)
  # ============================================
  test:
    name: Test
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ env.XCODE_VERSION }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-${{ env.XCODE_VERSION }}-

      - name: Test
        run: swift test -c release --parallel

  # ============================================
  # Build (reuses test cache)
  # ============================================
  build:
    name: Build
    runs-on: macos-14
    needs: [test]  # Only need test to pass, lint/security are informational
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ env.XCODE_VERSION }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-${{ env.XCODE_VERSION }}-

      - name: Build
        run: |
          xcodebuild -scheme MacML \
            -destination 'platform=macOS' \
            -configuration Release \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            -quiet \
            build

      - name: Package
        id: pkg
        run: |
          VERSION="${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'dev' }}-${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          PRODUCTS="DerivedData/Build/Products/Release"
          APP="${APP_NAME}.app"
          
          mkdir -p "$APP/Contents/MacOS" "$APP/Contents/Resources" "$APP/Contents/Frameworks"
          cp "$PRODUCTS/MacML" "$APP/Contents/MacOS/"
          cp Info.plist "$APP/Contents/"
          
          # Copy bundles
          for b in "$PRODUCTS"/*.bundle; do [ -d "$b" ] && cp -R "$b" "$APP/Contents/Resources/"; done
          
          # Copy scripts
          [ -d "Resources/Scripts" ] && cp -R Resources/Scripts "$APP/Contents/Resources/"
          
          echo -n "APPL????" > "$APP/Contents/PkgInfo"
          codesign --force --deep --sign - "$APP"
          
          ditto -c -k --keepParent "$APP" "${APP_NAME}-${VERSION}.zip"
          echo "zip=${APP_NAME}-${VERSION}.zip" >> $GITHUB_OUTPUT

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ steps.pkg.outputs.version }}
          path: ${{ steps.pkg.outputs.zip }}
          retention-days: 7

      - name: PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### âœ… Build Ready
            **Version:** \`${{ steps.pkg.outputs.version }}\`
            [Download Artifact](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Build Ready'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body
              });
            }
