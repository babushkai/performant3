name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: Label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: Suggest release label from PR title
        uses: actions/github-script@v8
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prLabels = context.payload.pull_request.labels.map(l => l.name);

            // Skip if already has a release label
            const hasReleaseLabel = prLabels.some(l => l.startsWith('release:'));
            if (hasReleaseLabel) {
              console.log('PR already has a release label');
              return;
            }

            let suggestedLabel = null;
            let comment = null;

            // Check conventional commit format
            if (/^(breaking|!):/i.test(prTitle) || /BREAKING CHANGE/i.test(prTitle)) {
              suggestedLabel = 'release:major';
              comment = 'This PR appears to contain **breaking changes**. Suggested label: `release:major`';
            } else if (/^feat(\(.+\))?:/i.test(prTitle)) {
              suggestedLabel = 'release:minor';
              comment = 'This PR adds a **new feature**. Suggested label: `release:minor`';
            } else if (/^fix(\(.+\))?:/i.test(prTitle)) {
              suggestedLabel = 'release:patch';
              comment = 'This PR contains a **bug fix**. Suggested label: `release:patch`';
            } else if (/^(docs|chore|style|refactor|test|ci)(\(.+\))?:/i.test(prTitle)) {
              suggestedLabel = 'release:skip';
              comment = 'This PR contains **non-release changes**. Suggested label: `release:skip` (no release will be created)';
            }

            if (suggestedLabel && comment) {
              // Add the suggested label
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [suggestedLabel]
                });
                console.log(`Added label: ${suggestedLabel}`);
              } catch (error) {
                console.log(`Could not add label: ${error.message}`);
              }
            }

  ensure-labels-exist:
    name: Ensure Release Labels Exist
    runs-on: ubuntu-latest

    steps:
      - name: Create release labels if missing
        uses: actions/github-script@v8
        with:
          script: |
            const labels = [
              { name: 'release:major', color: 'b60205', description: 'Breaking change - triggers major version bump' },
              { name: 'release:minor', color: '0e8a16', description: 'New feature - triggers minor version bump' },
              { name: 'release:patch', color: 'fbca04', description: 'Bug fix - triggers patch version bump' },
              { name: 'release:skip', color: 'cccccc', description: 'No release - skip version bump' },
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
                console.log(`Label "${label.name}" already exists`);
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`Created label "${label.name}"`);
                }
              }
            }
